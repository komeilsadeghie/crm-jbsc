# راهنمای استفاده از قالب PDF فارسی

## خلاصه تغییرات

سیستم تولید PDF قرارداد به طور کامل بازنویسی شده تا از متن فارسی به درستی پشتیبانی کند.

### مشکلات حل شده:
1. ✅ فونت فارسی به درستی embed می‌شود
2. ✅ متن فارسی با RTL (راست به چپ) به درستی نمایش داده می‌شود
3. ✅ حروف فارسی به درستی شکل‌دهی (shaping) می‌شوند
4. ✅ قالب قرارداد کامل بر اساس فایل Word شما ایجاد شده
5. ✅ تمام بخش‌های قرارداد قابل تغییر و سفارشی‌سازی هستند

## نصب و راه‌اندازی

### 1. نصب پکیج‌های لازم

پکیج‌های زیر نصب شده‌اند:
- `arabic-persian-reshaper` - برای شکل‌دهی حروف فارسی
- `bidi-js` - برای پشتیبانی از راست به چپ

### 2. اضافه کردن فونت فارسی

**مهم:** برای نمایش صحیح متن فارسی، باید یک فونت فارسی اضافه کنید:

1. فونت فارسی را دانلود کنید (پیشنهاد: Vazirmatn)
   - لینک: https://github.com/rastikerdar/vazirmatn
   - فایل مورد نیاز: `Vazirmatn-Regular.ttf`

2. فایل فونت را در یکی از مسیرهای زیر قرار دهید:
   - `fonts/Vazirmatn-Regular.ttf` (پیشنهاد می‌شود)
   - `src/fonts/Vazirmatn-Regular.ttf`
   - `dist/fonts/Vazirmatn-Regular.ttf`

3. سیستم به صورت خودکار فونت را پیدا کرده و استفاده می‌کند

**نکته:** اگر فونت فارسی پیدا نشود، سیستم از فونت پیش‌فرض استفاده می‌کند که ممکن است نمایش فارسی را به درستی انجام ندهد.

## ساختار قالب قرارداد

قالب قرارداد در فایل `src/config/contractTemplate.ts` تعریف شده و شامل بخش‌های زیر است:

### بخش‌های قابل تغییر:

1. **Header (هدر)**
   - نام شرکت
   - شماره تلفن
   - آدرس

2. **Title (عنوان)**
   - عنوان اصلی قرارداد

3. **Article 1 (ماده اول)** - عنوان تنظیم قرارداد
   - محتوا به صورت تابع قابل تغییر است

4. **Article 2 (ماده دوم)** - موضوع قرارداد
   - نام پکیج
   - عنوان پروژه
   - لیست موارد ارائه شده

5. **Article 3 (ماده سوم)** - مدت انجام قرارداد
   - روزهای اجرا
   - ماه‌های اعتبار

6. **Article 4 (ماده چهارم)** - تعهدات مجری
   - لیست تعهدات

7. **Article 5 (ماده پنجم)** - تعهدات کارفرما
   - لیست تعهدات

8. **Article 6 (ماده ششم)** - مبلغ قرارداد
   - محاسبه خودکار اقساط

9. **Article 7 (ماده هفتم)** - حل اختلاف

10. **Article 8 (ماده هشتم)** - فسخ قرارداد

11. **Article 9 (ماده نهم)** - پشتیبانی

12. **Signatures (امضاها)**
    - نام مجری
    - نام کارفرما

13. **Footer (فوتر)**
    - شماره تلفن
    - آدرس

## نحوه تغییر قالب

### روش 1: تغییر در فایل تنظیمات

فایل `src/config/contractTemplate.ts` را باز کرده و مقادیر `defaultContractTemplate` را تغییر دهید.

مثال:
```typescript
export const defaultContractTemplate: ContractTemplateConfig = {
  header: {
    companyName: 'نام شرکت شما',
    phone: 'شماره تلفن شما',
    address: 'آدرس شما',
  },
  // ... سایر بخش‌ها
};
```

### روش 2: ارسال قالب سفارشی هنگام تولید PDF

```typescript
import { generateContractPDF } from './services/pdf-generator';
import { ContractTemplateConfig } from './config/contractTemplate';

const customTemplate: ContractTemplateConfig = {
  // ... قالب سفارشی شما
};

const pdfBuffer = await generateContractPDF(contract, customTemplate);
```

## استفاده از API

API موجود تغییر نکرده است. همان endpoint قبلی استفاده می‌شود:

```
GET /api/contracts/:id/pdf
```

## تنظیمات شرکت

سیستم به صورت خودکار اطلاعات شرکت را از جدول `settings` می‌خواند:
- `company_name` - نام شرکت
- `company_phone` - شماره تلفن
- `company_address` - آدرس

این اطلاعات در هدر و فوتر PDF استفاده می‌شوند.

## عیب‌یابی

### مشکل: متن فارسی به درستی نمایش داده نمی‌شود

**راه حل:**
1. مطمئن شوید فونت فارسی در مسیر صحیح قرار دارد
2. فایل فونت باید `.ttf` باشد
3. نام فایل باید دقیقاً `Vazirmatn-Regular.ttf` باشد (یا مسیر را در کد تغییر دهید)

### مشکل: حروف قاطی پاطی هستند

**راه حل:**
1. مطمئن شوید پکیج‌های `arabic-persian-reshaper` و `bidi-js` نصب شده‌اند
2. سرور را restart کنید

### مشکل: متن به گوشه راست می‌چسبد

**راه حل:**
این مشکل باید حل شده باشد. اگر هنوز وجود دارد، بررسی کنید:
1. فونت فارسی به درستی register شده باشد
2. تابع `processText` به درستی کار می‌کند

## فایل‌های ایجاد شده

1. `src/utils/persianTextHelper.ts` - توابع کمکی برای پردازش متن فارسی
2. `src/config/contractTemplate.ts` - تنظیمات قالب قرارداد
3. `fonts/README.md` - راهنمای اضافه کردن فونت فارسی
4. `src/services/pdf-generator.ts` - بازنویسی شده با پشتیبانی کامل فارسی

## نکات مهم

1. **فونت فارسی ضروری است** - بدون فونت فارسی، نمایش متن ممکن است مشکل داشته باشد
2. **تمام بخش‌ها قابل تغییر هستند** - می‌توانید هر بخشی از قالب را تغییر دهید
3. **پشتیبانی از چند صفحه** - سیستم به صورت خودکار صفحات جدید اضافه می‌کند
4. **RTL خودکار** - تمام متن‌ها به صورت خودکار راست به چپ می‌شوند

## پشتیبانی

اگر مشکلی پیش آمد:
1. لاگ‌های سرور را بررسی کنید
2. مطمئن شوید فونت فارسی در مسیر صحیح است
3. پکیج‌ها را دوباره نصب کنید: `npm install`

