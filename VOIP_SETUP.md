# راه‌اندازی مانیتورینگ VOIP با AGI Isabel

این راهنما نحوه اتصال سیستم CRM به AGI Isabel برای مانیتورینگ تماس‌های ورودی و خروجی را توضیح می‌دهد.

## پیش‌نیازها

1. سرور AGI Isabel نصب و راه‌اندازی شده باشد
2. دسترسی به API یا AMI (Asterisk Manager Interface) در Isabel
3. اطلاعات اتصال (Host, Port, Username, Password)

## تنظیمات

### 1. تنظیم متغیرهای محیطی

در فایل `.env` در ریشه پروژه، متغیرهای زیر را اضافه کنید:

```env
# AGI Isabel Configuration
ISABEL_HOST=your-isabel-host.com
ISABEL_PORT=8088
ISABEL_USERNAME=your-username
ISABEL_PASSWORD=your-password
ISABEL_PROTOCOL=http
ISABEL_ENABLED=true
```

### 2. اطلاعات مورد نیاز

- **ISABEL_HOST**: آدرس IP یا دامنه سرور Isabel
- **ISABEL_PORT**: پورت API (معمولاً 8088 برای HTTP یا 8089 برای HTTPS)
- **ISABEL_USERNAME**: نام کاربری برای دسترسی به API
- **ISABEL_PASSWORD**: رمز عبور
- **ISABEL_PROTOCOL**: پروتکل اتصال (`http` یا `https`)
- **ISABEL_ENABLED**: فعال/غیرفعال کردن اتصال (`true` یا `false`)

## API Endpoints

سیستم از طریق API endpoints زیر با AGI Isabel ارتباط برقرار می‌کند:

### 1. بررسی وضعیت اتصال
```
GET /api/voip/config
```

### 2. دریافت لاگ تماس‌ها
```
GET /api/voip/logs?date_from=YYYY-MM-DD&date_to=YYYY-MM-DD&user=USER_ID&type=incoming|outgoing
```

### 3. دریافت آمار تماس‌ها
```
GET /api/voip/statistics?date_from=YYYY-MM-DD&date_to=YYYY-MM-DD
```

### 4. مانیتورینگ زنده
```
GET /api/voip/realtime
```

## قابلیت‌های مانیتورینگ

### 1. نمایش لاگ تماس‌ها
- تاریخ و زمان تماس
- شماره مبدا و مقصد
- کاربر مسئول تماس
- نوع تماس (ورودی/خروجی)
- مدت تماس
- وضعیت تماس (پاسخ داده شده، بدون پاسخ، مشغول)

### 2. آمار تماس‌ها
- تعداد کل تماس‌ها
- تعداد تماس‌های ورودی
- تعداد تماس‌های خروجی
- میانگین مدت تماس
- آمار تماس هر کاربر

### 3. مانیتورینگ زنده
- نمایش تماس‌های فعال در لحظه
- تعداد کانال‌های فعال
- اطلاعات تماس‌های در حال انجام

## تنظیمات AGI Isabel

برای فعال‌سازی API در AGI Isabel:

1. وارد پنل مدیریت Isabel شوید
2. به بخش **Settings** → **API Configuration** بروید
3. API را فعال کنید
4. یک کاربر API ایجاد کنید
5. دسترسی‌های لازم را به کاربر بدهید

### دسترسی‌های مورد نیاز

- **CDR (Call Detail Records)**: برای دریافت لاگ تماس‌ها
- **Channels**: برای مانیتورینگ زنده
- **Statistics**: برای دریافت آمار

## تست اتصال

پس از تنظیم متغیرهای محیطی:

1. سرور را راه‌اندازی مجدد کنید
2. به صفحه **مانیتورینگ VOIP** بروید
3. وضعیت اتصال را بررسی کنید
4. اگر اتصال برقرار باشد، آیکون سبز نمایش داده می‌شود

## عیب‌یابی

### مشکل: اتصال برقرار نمی‌شود

1. بررسی کنید که سرور Isabel در دسترس باشد
2. اطلاعات اتصال را بررسی کنید
3. فایروال را بررسی کنید که پورت‌ها باز باشند
4. لاگ‌های سرور را بررسی کنید

### مشکل: لاگ تماس‌ها نمایش داده نمی‌شود

1. بررسی کنید که CDR در Isabel فعال باشد
2. بررسی کنید که کاربر API دسترسی به CDR داشته باشد
3. بازه تاریخ را بررسی کنید

### مشکل: مانیتورینگ زنده کار نمی‌کند

1. بررسی کنید که AMI در Isabel فعال باشد
2. بررسی کنید که کاربر API دسترسی به Channels داشته باشد
3. بررسی کنید که به‌روزرسانی خودکار فعال باشد

## نکات مهم

- برای امنیت بیشتر، از HTTPS استفاده کنید
- رمز عبور را در فایل `.env` نگه دارید و آن را در Git commit نکنید
- به‌روزرسانی خودکار را برای مانیتورینگ زنده فعال کنید
- بازه تاریخ را برای فیلتر کردن لاگ‌ها استفاده کنید

## پشتیبانی

در صورت بروز مشکل، لطفاً با تیم پشتیبانی تماس بگیرید.

